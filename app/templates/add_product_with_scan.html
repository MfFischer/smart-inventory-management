{% extends "base.html" %}

{% block content %}
<div class="container mt-4 text-white bg-dark p-4 rounded" style="max-width: 600px;">
    <h1 class="text-center">Add Product by Scanning Barcode/QR Code</h1>

    <button id="scanButton" class="btn btn-primary w-100">Scan Barcode/QR Code</button>
    <div id="scanner-container" class="mt-3">
        <video id="video" width="100%" height="200" style="display:none;" class="rounded"></video>
        <div id="errorMessage" class="alert alert-danger mt-2" style="display:none;"></div>
    </div>

    <form id="productForm" method="post" action="{{ url_for('products.add_product_with_scan') }}" class="mt-4">
        <div class="form-group">
            <label for="barcode">Barcode:</label>
            <input type="text" id="barcode" name="barcode" class="form-control" readonly required>
        </div>

        <div class="form-group mt-3">
            <label for="name">Product Name:</label>
            <input type="text" id="name" name="name" class="form-control" required>
        </div>

        <div class="form-group mt-3">
            <label for="description">Description:</label>
            <textarea id="description" name="description" class="form-control"></textarea>
        </div>

        <div class="form-group mt-3">
            <label for="price">Selling Price:</label>
            <input type="number" id="price" name="price" class="form-control" step="0.01" required>
        </div>

        <div class="form-group mt-3">
            <label for="cost_price">Cost Price:</label>
            <input type="number" id="cost_price" name="cost_price" class="form-control" step="0.01" required>
        </div>

        <div class="form-group mt-3">
            <label for="quantity_in_stock">Initial Stock:</label>
            <input type="number" id="quantity_in_stock" name="quantity_in_stock" class="form-control" required>
        </div>

        <div class="form-group mt-3">
            <label for="reorder_point">Reorder Point:</label>
            <input type="number" id="reorder_point" name="reorder_point" class="form-control" required>
        </div>

        <div class="form-group mt-3">
            <label for="supplier_id">Supplier:</label>
            <select id="supplier_id" name="supplier_id" class="form-control" required>
                <option value="">Select a supplier</option>
                {% for supplier in suppliers %}
                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn btn-success mt-4 w-100">Add Product</button>
        <a href="{{ url_for('products.render_product_list') }}" class="btn btn-secondary mt-3 w-100">Back to Products</a>
    </form>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
    const video = document.getElementById('video');
    const scanButton = document.getElementById('scanButton');
    const errorMessage = document.getElementById('errorMessage');
    let codeReader = null;

    async function initializeScanner() {
        try {
            // Check if camera is available
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');

            if (videoDevices.length === 0) {
                throw new Error('No camera found on this device');
            }

            // Initialize ZXing code reader
            codeReader = new ZXing.BrowserMultiFormatReader();

            // Show video element
            video.style.display = 'block';

            try {
                // Start scanning
                const result = await codeReader.decodeFromConstraints(
                    {
                        video: { facingMode: "environment" }
                    },
                    video,
                    (result, err) => {
                        if (result) {
                            document.getElementById('barcode').value = result.text;
                            stopScanning();
                            video.style.display = 'none';
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.error(err);
                            showError('Error while scanning. Please try again.');
                        }
                    }
                );
            } catch (err) {
                showError('Failed to start scanner. Please make sure you\'ve granted camera permissions.');
                console.error(err);
            }
        } catch (err) {
            showError('Unable to access camera. Please make sure you\'ve granted camera permissions.');
            console.error(err);
        }
    }

    function stopScanning() {
        if (codeReader) {
            codeReader.reset();
            video.style.display = 'none';
            errorMessage.style.display = 'none';
        }
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        video.style.display = 'none';
    }

    scanButton.addEventListener('click', async () => {
        errorMessage.style.display = 'none';

        // Check if the browser supports getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showError('Your browser doesn\'t support camera access');
            return;
        }

        try {
            // Request camera permission
            await navigator.mediaDevices.getUserMedia({ video: true });
            await initializeScanner();
        } catch (err) {
            showError('Failed to access camera. Please grant camera permissions.');
            console.error(err);
        }
    });

    // Clean up when leaving the page
    window.addEventListener('beforeunload', () => {
        stopScanning();
    });
</script>
{% endblock %}